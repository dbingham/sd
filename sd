#!/usr/bin/env bash

sd() {
  local sdd=$HOME/.sdd
  [[ -d $sdd ]] || mkdir $sdd

  local point_name=$2
  local point_path=$sdd/$point_name
  local point_destination=$(readlink $point_path)
  [[ -z "$point_destination" ]] && point_destination="no point destination"

  case "x$1" in
  xadd)
    if ln -s $PWD $point_path &> /dev/null; then
      echo "Added shift point '$point_name' ($PWD)"
      return 0
    else
      echo "Error adding shift point '$point_name' ($PWD)"
      return 1
    fi
    ;;
  xrm)
    if rm $point_path &> /dev/null; then
      echo "Removed shift point '$point_name' ($point_destination)"
      return 0
    else
      echo "Error removing shift point '$point_name' ($point_destination)"
      return 1
    fi
    ;;
  xls)
    local point_list=$(ls -l $sdd | grep -v '^total' | awk '{printf "%s\t%s\n", $9, $11}')
    echo "$point_list" | grep "$2"
    return 0
    ;;
  x-h | x--help)
    echo "Usage: sd [command] <point_name>"
    echo "Commands:"
    echo "  add <point_name>    Adds the current working directory to your shift points"
    echo "  rm <point_name>     Removes the named point from your shift points"
    echo "  ls                  Prints all shift points"
    echo "  ls <point_name>     Prints all shift points matching the specified name"
    echo "  -                   Shifts to previous working directory"
    echo "  -h, --help          Prints this lovely message"
    return 0
    ;;
  x-)
    cd -
    return $?
    ;;
  x-*)
    echo "Unknown option: '$1'"
    return 1
    ;;
  esac

  # if we get here, we're shifting
  local requested_point=$1
  point_path=$sdd/$requested_point
  if [[ ! -e $point_path ]]; then
    echo "Can't shift to point '$requested_point,' it doesn't exist."
    return 1
  fi

  local requested_destination=$(readlink $point_path)
  cd $requested_destination
  return $?
}

_shift_points() {
  local sdd=$HOME/.sdd
  [[ -d $sdd ]] || mkdir $sdd

  ls $sdd
}

_sd_autocomplete() {
  local current=${COMP_WORDS[COMP_CWORD]}

  COMPREPLY=($(compgen -W "$(_shift_points)" -- $current))
}

complete -F _sd_autocomplete sd
